<?xml version="1.0" ?>
<node name="/Connection_Interface_Mail_Notification"
  xmlns:tp="http://telepathy.freedesktop.org/wiki/DbusSpec#extensions-v0"
  >
  <tp:copyright> Copyright (C) 2007 Collabora Limited </tp:copyright>
  <tp:license xmlns="http://www.w3.org/1999/xhtml">
    <p>This library is free software; you can redistribute it and/or
modify it under the terms of the GNU Lesser General Public
License as published by the Free Software Foundation; either
version 2.1 of the License, or (at your option) any later version.</p>

<p>This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Library General Public License for more details.</p>

<p>You should have received a copy of the GNU Lesser General Public
License along with this library; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</p>
  </tp:license>
  <interface
    name="org.freedesktop.Telepathy.Connection.Interface.MailNotification.DRAFT"
    tp:causes-havoc="experimental">
    <tp:requires interface="org.freedesktop.Telepathy.Connection"/>

    <tp:flags name="Mail_Notification_Flags" value-prefix="Mail_Notification" type="u" >
      <tp:flag suffix="Has_Prop_UnreadMailCount" value="1">
        <tp:docstring>
          The protocol provide up-to-date information about the number of 
          unread e-mails (or e-mails thread) in the user's mailbox. The
          connection manager will update this value by emitting the
          <tp:member-ref>UnreadMailsChanged</tp:member-ref> signal.
        </tp:docstring>
      </tp:flag>
      <tp:flag suffix="Has_Prop_UnreadMails" value="2">
        <tp:docstring>
          The protocol provide an up-to-date details' list about currently
          unread e-mails. The connection manager must also provide the 
          <tp:member-ref>UnreadMailCount</tp:member-ref>
          property. Connection managers that support this feature must not emit 
          <tp:member-ref>MailsReceived</tp:member-ref> signal.
          The connection manager will update this value by emitting the
          <tp:member-ref>UnreadMailsChanged</tp:member-ref> signals.
        </tp:docstring>
      </tp:flag>
      <tp:flag suffix="Has_Signal_MailsReceived" value="4">
        <tp:docstring>
        This connection manager emits <tp:member-ref>MailsReceived</tp:member-ref>
        signal which provide details about newly arrived e-mails but does not 
        maintain their read status afterward. It must only emit this signal if
        they have real-time information about e-mails or threads but would not
        be unable to remove them from the <tp:member-ref>UnreadMails</tp:member-ref> 
        array because unread to read status is not reported.
        </tp:docstring>
      </tp:flag>
      <tp:docstring>
        Flags representing capabilities that may be provided by a connection 
        manager. Those value can be used as bitfield. Some flags may depend 
        or conflict with others.
      </tp:docstring>
    </tp:flags>

    <tp:enum name="HTTP_Method" type="u"> 
      <tp:enumvalue suffix="Get" value="0">
        <tp:docstring>
          Use GET method when opening the URL.
        </tp:docstring>
      </tp:enumvalue>
      <tp:enumvalue suffix="Post" value="1">
        <tp:docstring>
          Use POST method when opening the URL.
        </tp:docstring>
      </tp:enumvalue>
      <tp:docstring>
        HTTP Method.
      </tp:docstring>
    </tp:enum>

    <tp:struct name="HTTP_Post_Data" array-name="HTTP_Post_Data_List">
      <tp:docstring>
        A pair (key, value) representing POST Data.
      </tp:docstring>
      <tp:member type="s" name="key"/>
      <tp:member type="s" name="value"/>
    </tp:struct>

    <tp:struct name="Mail_Address" array-name="Mail_Address_List">
      <tp:docstring>
        A pair (name, address) representing an e-mail address.
      </tp:docstring>
      <tp:member type="s" name="name"/>
      <tp:member type="s" name="address"/>
    </tp:struct>

    <tp:enum name="Mail_Type" type="u"> 
      <tp:enumvalue suffix="single" value="0">
        <tp:docstring>
          The e-mail is represented as a single reply by only
          one sender.
        </tp:docstring>
      </tp:enumvalue>
      <tp:enumvalue suffix="thread" value="1">
        <tp:docstring>
          The e-mail refer to a thread where multiple person may
          have replied.
        </tp:docstring>
      </tp:enumvalue>
      <tp:docstring>
        E-mail representation type.
      </tp:docstring>
    </tp:enum>

    <tp:struct name="Mail_URL">
      <tp:docstring>
        Structure that contains required information to open Web base e-mail 
        UI without need for re-authentication.
      </tp:docstring>
      <tp:member type="s" name="url">
        <tp:docstring>
          URL of the inbox folder or mail Web viewer.
        </tp:docstring>
      </tp:member>
      <tp:member type="u" name="method" tp:type="HTTP_Method">
        <tp:docstring>
          HTTP Method for opening URL.
        </tp:docstring>
      </tp:member>
      <tp:member type="a(ss)" name="post_data" tp:type="HTTP_Post_Data[]">
        <tp:docstring>
          Array of name-value pair structs of the POST data to use when opening
          the URL. Because of the nature of the POST data, this information may
          not be shared between clients.
        </tp:docstring>
      </tp:member>
    </tp:struct>

    <tp:simple-type name="Mail" type="a{sv}" array-name="Mail_List">
      <tp:docstring>
        E-mail representation has been reduced to hash table with possible keys (of type strings) 
        listed above. All keys are optional except the "id" key that must be provided by every 
        protocol that support unread mail listing. Without this key, it would not be impossible to 
        unlist the e-mails that are no longer marked as unread.
        <tp:rationale>
          The hash map will allow extending the protocol without any ABI 
          changes. Only the documentation will need to be updated.
        </tp:rationale>
      
        <div class="indent">
        <h3>Keys</h3>
        <ul>
          <li>id &#8212; s</li>
          <div class="docstring">A unique ID for this e-mail</div>

          <li>type &#8212; u (<tp:type>Mail_Type</tp:type>)</li>
          <div class="docstring">
            Type of e-mail. This can be set to "single", which means e-mails 
            are represented separately, or "thread", when information is described
            by the protocol as thread. Note that threads may have multiple unread senders.
          </div>

          <li>url_data &#8212; s</li>
          <div class="docstring">An opaque string used to build URL when
            calling <tp:member-ref>RequestMailURL</tp:member-ref>.
          </div>

          <li>senders &#8212; a(ss) (<tp:type>Mail_Address</tp:type>)</li>
          <div class="docstring">
            An array of sender display name and e-mail address pair. Note that 
            only e-mails thread may have multiple senders.
          </div>

          <li>to-addresses &#8212; a(ss) (<tp:type>Mail_Address</tp:type>)</li>
          <div class="docstring">
            An array of display name and e-mail address pair of
            the recipients.
          </div>

          <li>cc-addresses &#8212; a(ss) (<tp:type>Mail_Address</tp:type>)</li>
          <div class="docstring">
            An array of display name and e-mail address pair of the carbon
            copy recipients.
          </div>

          <li>subject &#8212; s</li>
          <div class="docstring">The subject of the message.</div>

          <li>sent-timestamp &#8212; u</li>
          <div class="docstring">A UNIX timestamp of when the message has been sent (in seconds).</div>

          <li>received-timestamp &#8212; u</li>
          <div class="docstring">A UNIX timestamp of when the message has been received (in seconds).</div>

          <li>has-attachments &#8212; b</li>
          <div class="docstring">A boolean of whether this message has attachments.</div>

          <li>content-type &#8212; s</li>
          <div class="docstring">
            MIME type of the message contents. Plain text should be
            assumed if unset.
          </div>

          <li>snippet &#8212; s</li>
          <div class="docstring">
            A small part of the message body (content-type should
            be set if this message is HTML encoded).
          </div>

          <li>body &#8212; s</li>
          <div class="docstring">
            The body of the message (content-type should
            be set if this message is HTML encoded).
          </div>

          <li>folder &#8212; s</li>
          <div class="docstring">
            The name of the folder containing this e-mails. 
            If unset, inbox will be assumed.
          </div>
        </ul>
        </div>
      </tp:docstring>
    </tp:simple-type>
   
    <property name="Capabilities" type="u" access="read"
      tp:type="Mail_Notification_Flags" tp:name-for-bindings="Capabilities">
      <tp:docstring>
        Integer representing the bitwise-OR of supported features for e-mails 
        notification on this server.
        <tp:rational>
          This property explicitly state the behavior and availability
          of the other properties and signals within this interface. A
          connection manager that cannot at least set one of the flag
          in the <tp:type>Mail_Notification_Flags</tp:type>
          should not provide this interface.
        </tp:rational>
      </tp:docstring>
    </property>

    <property name="UnreadMailCount" type="u" access="read"
      tp:name-for-bindings="Unread_Mail_Count">
      <tp:docstring>
        The number of unread messages in the inbox.
      </tp:docstring>
    </property>

    <property name="UnreadMails" type="aa{sv}" tp:type="Mail[]"
      tp:name-for-bindings="Unread_Mails" access="read">
      <tp:docstring>
        A array of unread <tp:type>Mail</tp:type>s.
      </tp:docstring>
    </property>

    <signal name="MailsReceived" tp:name-for-bindings="Mails_Received">
      <arg name="mails" type="aa{sv}" tp:type="Mail[]">
        <tp:docstring>
          An array of <tp:type>Mail</tp:type>s. Those e-mails do not have a unique "ID".
        </tp:docstring>
      </arg>

      <tp:docstring>
        Emitted when new e-mails messages arrive to the inbox associated with
        this connection. This signal is used for protocol that are not able
        to maintained <tp:member-ref>UnreadMails</tp:member-ref> list but
        receives real-time notification about newly arrived e-mails.
      </tp:docstring>
    </signal>

    <signal name="UnreadMailsChanged"
      tp:name-for-bindings="Unread_Mails_Changed">
      <arg name="count" type="u">
        <tp:docstring>
          Number of unread messages in the inbox (the new value of
          <tp:member-ref>UnreadMailCount</tp:member-ref>).
        </tp:docstring>
      </arg>
      <arg name="mails_added" type="aa{sv}" tp:type="Mail[]">
        <tp:docstring>
          A list of <tp:type>Mail</tp:type> that are being added or updated in
          <tp:member-ref>UnreadMails</tp:member-ref>. This list will be
          empty if the protocol does not support listing unread e-mails
          or threads.
          <tp:rationale>
            Mails may be updated when the URL information (url and POST Data) 
            have changed, or senders were added or removed from an e-mails 
            thread (see <tp:type>Mail_Type</tp:type>).
          </tp:rationale>
        </tp:docstring>
      </arg>
      <arg name="mails_removed" type="as">
        <tp:docstring>
          A list of e-mails ID that are being removed from
          <tp:member-ref>UnreadMails</tp:member-ref>. This list will be
          empty if the protocol does not support listing unread e-mails
          or threads.
        </tp:docstring>
      </arg>
      <tp:docstring>
        Emitted when <tp:member-ref>UnreadMails</tp:member-ref> or 
        <tp:member-ref>UnreadMailCount</tp:member-ref> have changed.
      </tp:docstring>
    </signal>

    <method name="Subscribe"
        tp:name-for-bindings="Subscribe">
      <tp:docstring>
        This method subscribes a client to the notification interface. This
        should be called if a client wants to get notified of incoming
        e-mails. Before anyone subscribes to the interface, the connection
        manager should try to minimized memory usage and network traffic as
        much as possible. The Control Manager must detect client disconnection
        (e.g. in case of crash) and free resources that are no longer required.
      </tp:docstring>
      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.Disconnected"/>
        <tp:error name="org.freedesktop.Telepathy.Error.NetworkError"/>
        <tp:error name="org.freedesktop.Telepathy.Error.NotAvailable"/>
        <tp:error name="org.freedesktop.Telepathy.Error.PermissionDenied"/>
      </tp:possible-errors>
    </method>

    <method name="Unsubscribe"
        tp:name-for-bindings="Unsubscribe">
      <tp:docstring>
        This method unsubscribes a client from the notification interface. This
        should called if a client no longer wants tot get notified of incoming
        e-mails. When all the client has been Unsubscribed, the connection manager
        should free all non-required information and reduce network traffic. It must
        be possible to call Subscribe later.
      </tp:docstring>
      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.Disconnected"/>
        <tp:error name="org.freedesktop.Telepathy.Error.NetworkError"/>
        <tp:error name="org.freedesktop.Telepathy.Error.NotAvailable"/>
        <tp:error name="org.freedesktop.Telepathy.Error.PermissionDenied"/>
      </tp:possible-errors>
    </method>

    <method name="RequestInboxURL"
      tp:name-for-bindings="Request_Inbox_URL">
      <arg direction="out" name="url" type="(sua(ss))" tp:type="Mail_URL" >
        <tp:docstring>
          A struture that contains URL and any additional data to open Web
          mail client without re-authentication.
        </tp:docstring>
      </arg>
      <tp:docstring>
        This method create and return a URL and optionnal POST data that allow
        openning the Inbox folder of your Web mail account. This URL may 
        contains token with short life time. Thus, a client should not reuse it
        and request a new URL whenever it is needed.
        <tp:rationale>
          We are not using properties here because the tokens may not be shared
          between clients and that network may be required to obtain the
          information that leads to authentication free Web access.
        </tp:rationale>
      </tp:docstring>
    </method>

    <method name="RequestMailURL"
      tp:name-for-bindings="Request_Mail_URL">
      <arg direction="in" name="id" type="s">
        <tp:docstring>
          The mail ID as found in <tp:type>Mail</tp:type> structure.
        </tp:docstring>
      </arg>
      <arg direction="in" name="url_data" type="s">
        <tp:docstring>
          An opaque string that contains information required by CM to build
          a correct URL for opening Web mail client without re-authentication.
          This token is part of <tp:type>Mail</tp:type> structure.
        </tp:docstring>
      </arg>
      <arg direction="out" name="url" type="(sua(ss))" tp:type="Mail_URL" >
        <tp:docstring>
          A struture that contains URL and any additional data to open Web
          mail client without re-authentication.
        </tp:docstring>
      </arg>
      <tp:docstring>
        This method create and return a URL and optionnal POST data that allow
        openning specific mail of your Web mail account. Refer to 
        <tp:member-ref>RequestInboxURL</tp:member-ref>.
      </tp:docstring>
    </method>

    <tp:docstring xmlns="http://www.w3.org/1999/xhtml">
      <p>An interface to support receiving notifications about a e-mail
        account associated with this connection. It is intended that the
        connection manager has the means to provide necessary
        information (URL, method, POST data) so that the client is 
        able to open the user's inbox and possibly individual messages without 
        having to re-authenticate. To use this interface, a client must first
        subscribe using the <tp:member-ref>Subscribe</tp:member-ref> method.</p>

      <p>When unread e-mails arrive into the into or unread e-mails are marked 
        read or deleted the
        <tp:member-ref>UnreadMailsChanged</tp:member-ref> signal
        will be emitted with the new value of
        <tp:member-ref>UnreadMailCount</tp:member-ref>, an array
        of new or modified mails and the list of removed e-mail unique IDs. 
        To open the web base mail client for the inbox folder or a specific
        mail client must call <tp:member-ref>RequestInboxURL</tp:member-ref>
        or <tp:member-ref>RequestMailURL</tp:member-ref>. Those methods
        will do proper actions to retreive the information and provide
        authentication free URL to the requested Web client interface.
      </p>
      <p>
        Some protocol may not be able to provide a list of unread e-mails
        but may provide some information about the messages received. On
        such protocols, the <tp:member-ref>MailsReceived</tp:member-ref>
        signal will also be emitted, with information about the e-mails.
        The protocol does not keep track of any of this information.
      </p>
    </tp:docstring>
  </interface>
</node>
<!-- vim:set sw=2 sts=2 et ft=xml: -->

